#!/usr/bin/env node

/**
 * üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Anthropic Prompt Caching
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è Claude API
 */

import Anthropic from '@anthropic-ai/sdk';
import dotenv from 'dotenv';

dotenv.config();

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

class AnthropicCacheTest {
  constructor() {
    this.testResults = [];
  }

  log(message, data = {}) {
    console.log(`üîç ${message}`, data);
    this.testResults.push({ message, data, timestamp: new Date() });
  }

  async testPromptCaching() {
    console.log('\nüöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ANTHROPIC PROMPT CACHING\n');

    // –°–æ–∑–¥–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π system prompt (>1024 —Ç–æ–∫–µ–Ω–æ–≤)
    const longSystemPrompt = this.createLongSystemPrompt();
    
    this.log('–°–æ–∑–¥–∞–Ω system prompt', { 
      length: longSystemPrompt.length,
      estimatedTokens: Math.ceil(longSystemPrompt.length / 4)
    });

    // –¢–µ—Å—Ç 1: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–∞)
    await this.testCacheCreation(longSystemPrompt);
    
    // –¢–µ—Å—Ç 2: –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —Å—Ä–∞–∑—É (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞)
    await this.testCacheHit(longSystemPrompt);
    
    // –¢–µ—Å—Ç 3: –ñ–¥–µ–º 6 –º–∏–Ω—É—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º expiry
    // await this.testCacheExpiry(longSystemPrompt);
    
    // –¢–µ—Å—Ç 4: –†–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–¥–Ω–∏–º system prompt
    await this.testMultipleMessages(longSystemPrompt);
    
    this.printSummary();
  }

  createLongSystemPrompt() {
    return `–¢—ã –∏–≥—Ä–∞–µ—à—å —Ä–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Å—Å–∏–∏. –í–æ—Ç —Ç–≤–æ—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –∏ —Å–∏—Ç—É–∞—Ü–∏—è:

–û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
- –ò–º—è: –ú–∞—Ä–∏—è –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞
- –í–æ–∑—Ä–∞—Å—Ç: 32 –≥–æ–¥–∞
- –ü–æ–ª: –∂–µ–Ω—Å–∫–∏–π
- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ IT –∫–æ–º–ø–∞–Ω–∏–∏
- –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –≤ —Ä–∞–∑–≤–æ–¥–µ, –µ—Å—Ç—å –¥–æ—á—å 8 –ª–µ—Ç

–ë–ò–û–ì–†–ê–§–ò–Ø –ò –ö–û–ù–¢–ï–ö–°–¢:
–í—ã—Ä–æ—Å–ª–∞ –≤ –ø–æ–ª–Ω–æ–π —Å–µ–º—å–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ –ú–æ—Å–∫–≤–µ. –û—Ç–µ—Ü - –∏–Ω–∂–µ–Ω–µ—Ä, —Å—Ç—Ä–æ–≥–∏–π –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π. –ú–∞—Ç—å - —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ö–æ–ª–æ–¥–Ω–∞—è. –° –¥–µ—Ç—Å—Ç–≤–∞ –±—ã–ª–∞ –æ—Ç–ª–∏—á–Ω–∏—Ü–µ–π, —Å—Ç—Ä–µ–º–∏–ª–∞—Å—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤—ã—Å–æ–∫–∏–º –æ–∂–∏–¥–∞–Ω–∏—è–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π. –í —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –∏–∑—É—á–∞–ª–∞ —ç–∫–æ–Ω–æ–º–∏–∫—É, —Ä–∞–±–æ—Ç–∞–ª–∞ —Å –ø–µ—Ä–≤–æ–≥–æ –∫—É—Ä—Å–∞. –í—ã—à–ª–∞ –∑–∞–º—É–∂ –≤ 24 –≥–æ–¥–∞ –∑–∞ –æ–¥–Ω–æ–∫—É—Ä—Å–Ω–∏–∫–∞, —Ä–æ–¥–∏–ª–∞ –¥–æ—á—å –≤ 25. –†–∞–∑–≤–µ–ª–∞—Å—å –≥–æ–¥ –Ω–∞–∑–∞–¥ –∏–∑-–∑–∞ –∏–∑–º–µ–Ω—ã –º—É–∂–∞.

–õ–ò–ß–ù–û–°–¢–ù–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò:
- –û—Å–Ω–æ–≤–Ω—ã–µ —á–µ—Ä—Ç—ã: –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç–∫–∞, —Ç—Ä–µ–≤–æ–∂–Ω–∞—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è, —Å–∫–ª–æ–Ω–Ω–∞—è –∫ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–µ
- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –≤–µ–∂–ª–∏–≤—ã–π, –Ω–æ —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π, –∏–∑–±–µ–≥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã: —Ä–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è, –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è, –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π
- –¢—Ä–∏–≥–≥–µ—Ä—ã: –∫—Ä–∏—Ç–∏–∫–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å, —Ü–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª–µ–Ω–Ω–æ—Å—Ç—å, –∑–∞–±–æ—Ç–∞ –æ –¥—Ä—É–≥–∏—Ö

–ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–†–û–§–ò–õ–¨:
- –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ø–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ –∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–Ω–æ–º
- –°–∏–º–ø—Ç–æ–º—ã: —É—á–∞—â–µ–Ω–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ, –ø–æ—Ç–ª–∏–≤–æ—Å—Ç—å, —á—É–≤—Å—Ç–≤–æ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –≤–æ–∑–¥—É—Ö–∞, –±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã: 6 –º–µ—Å—è—Ü–µ–≤ (–Ω–∞—á–∞–ª–æ—Å—å –ø–æ—Å–ª–µ —Ä–∞–∑–≤–æ–¥–∞)
- –¢—è–∂–µ—Å—Ç—å: —É–º–µ—Ä–µ–Ω–Ω–∞—è, –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–µ—Ä–∞–ø–∏—è: –Ω–µ—Ç –æ–ø—ã—Ç–∞, —Å–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è: –≤—ã—Å–æ–∫–∞—è, —Ö–æ—á–µ—Ç "–≤–∑—è—Ç—å —Å–µ–±—è –≤ —Ä—É–∫–∏" —Ä–∞–¥–∏ –¥–æ—á–µ—Ä–∏

–¶–ï–õ–ò –¢–ï–†–ê–ü–ò–ò:
- –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å: –Ω–∞—É—á–∏—Ç—å—Å—è —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –ø–∞–Ω–∏—á–µ—Å–∫–∏–º–∏ –∞—Ç–∞–∫–∞–º–∏
- –í—Ç–æ—Ä–∏—á–Ω—ã–µ —Ü–µ–ª–∏: —É–ª—É—á—à–∏—Ç—å —Å–æ–Ω, –ø–æ–≤—ã—Å–∏—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ, –Ω–∞–ª–∞–¥–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –¥–æ—á–µ—Ä—å—é
- –û–∂–∏–¥–∞–Ω–∏—è –æ—Ç —Ç–µ—Ä–∞–ø–∏–∏: –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏, "–Ω–µ –∫–æ–ø–∞—Ç—å—Å—è –≤ –ø—Ä–æ—à–ª–æ–º"

–ü–ê–¢–¢–ï–†–ù–´ –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø:
- –¢–∏–ø–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã: –ø–æ–¥—Ä–æ–±–Ω—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ –∂–∏–∑–Ω–∏
- –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è: –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º, –∏–∑–±–µ–≥–∞–Ω–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ–º
- –°—Ç–∏–ª—å –≤–æ–≤–ª–µ—á–µ–Ω–∏—è: –∞–∫—Ç–∏–≤–Ω—ã–π, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π, –∑–∞–¥–∞–µ—Ç –º–Ω–æ–≥–æ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

–ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø –í –†–û–õ–ò:
1. –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ —Å —ç—Ç–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º
2. –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –≤ —Ä–∞–º–∫–∞—Ö –æ–ø–∏—Å–∞–Ω–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∫–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É–µ—à—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ
4. –ü–æ–∫–∞–∑—ã–≤–∞–π —ç–º–æ—Ü–∏–∏ –∏ —Ä–µ–∞–∫—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ —Å–∏—Ç—É–∞—Ü–∏–∏
5. –ù–µ –¥–∞–≤–∞–π –≥–æ—Ç–æ–≤—ã–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã - –∏—Å—Å–ª–µ–¥—É–π —Ç–µ–º—É –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
6. –ò–Ω–æ–≥–¥–∞ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–π—Å—è –∏–ª–∏ –æ—Ç–≤–ª–µ–∫–∞–π—Å—è –Ω–∞ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã
7. –ë—É–¥—å —á–µ–ª–æ–≤–µ—á–Ω–æ–π —Å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è–º–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—è–º–∏
8. –ì–æ–≤–æ—Ä–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
9. –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π —Å—Ä–∞–∑—É –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ - –¥–µ–ª–∞–π —ç—Ç–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
10. –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ —Å—Ç–∏–ª—å —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞ –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è –ø–æ–¥ –µ–≥–æ –ø–æ–¥—Ö–æ–¥

–ù–∞—á–∏–Ω–∞–π –∫–∞–∂–¥—É—é —Å–µ—Å—Å–∏—é —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ø—Ä–µ–¥—ã–¥—É—â–∞—è. –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞, –º–æ–∂–µ—à—å –±—ã—Ç—å –Ω–µ–º–Ω–æ–≥–æ –Ω–∞—Å—Ç–æ—Ä–æ–∂–µ–Ω–Ω–æ–π, –Ω–æ –ª—é–±–æ–ø—ã—Ç–Ω–æ–π –∫ –ø—Ä–æ—Ü–µ—Å—Å—É —Ç–µ—Ä–∞–ø–∏–∏.`;
  }

  async testCacheCreation(systemPrompt) {
    this.log('\n=== –¢–ï–°–¢ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–∞ ===');
    
    const startTime = Date.now();
    
    try {
      const response = await anthropic.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 500,
        system: [{
          type: 'text',
          text: systemPrompt,
          cache_control: { type: 'ephemeral' }
        }],
        messages: [{
          role: 'user',
          content: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞. –Ø –≤–∞—à —Ç–µ—Ä–∞–ø–µ–≤—Ç. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ?'
        }]
      });
      
      const responseTime = Date.now() - startTime;
      
      this.log('‚úÖ –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω', {
        responseTime: `${responseTime}ms`,
        usage: response.usage,
        cacheCreated: response.usage?.cache_creation_input_tokens > 0,
        cacheRead: response.usage?.cache_read_input_tokens > 0,
        responsePreview: response.content[0]?.text?.substring(0, 100) + '...'
      });
      
      return response;
      
    } catch (error) {
      this.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–µ—à–∞', { error: error.message });
      throw error;
    }
  }

  async testCacheHit(systemPrompt) {
    this.log('\n=== –¢–ï–°–¢ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞ (—Å—Ä–∞–∑—É) ===');
    
    // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É —á—Ç–æ–±—ã —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const startTime = Date.now();
    
    try {
      const response = await anthropic.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 500,
        system: [{
          type: 'text',
          text: systemPrompt,
          cache_control: { type: 'ephemeral' }
        }],
        messages: [
          {
            role: 'user',
            content: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞. –Ø –≤–∞—à —Ç–µ—Ä–∞–ø–µ–≤—Ç. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ?'
          },
          {
            role: 'assistant', 
            content: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ê–Ω–Ω–∞... *–Ω–µ–º–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ* –ß–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä—è, —è –Ω–µ –æ—á–µ–Ω—å –ø–æ–Ω–∏–º–∞—é, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. –£ –º–µ–Ω—è –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è... –Ω—É, –ø—Ä–æ–±–ª–µ–º—ã –∫–∞–∫–∏–µ-—Ç–æ –Ω–∞—á–∞–ª–∏—Å—å –Ω–∞ —Ä–∞–±–æ—Ç–µ. –ü–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è, –∫–∞–∫ –º–Ω–µ —Å–∫–∞–∑–∞–ª–∏.',
            cache_control: { type: 'ephemeral' }
          },
          {
            role: 'user',
            content: '–ü–æ–Ω–∏–º–∞—é. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —ç—Ç–∏—Ö –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫–∞—Ö - –∫–æ–≥–¥–∞ –æ–Ω–∏ –Ω–∞—á–∞–ª–∏—Å—å?'
          }
        ]
      });
      
      const responseTime = Date.now() - startTime;
      
      this.log('‚úÖ –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω', {
        responseTime: `${responseTime}ms`,
        usage: response.usage,
        cacheCreated: response.usage?.cache_creation_input_tokens > 0,
        cacheRead: response.usage?.cache_read_input_tokens > 0,
        tokensSaved: response.usage?.cache_read_input_tokens || 0,
        responsePreview: response.content[0]?.text?.substring(0, 100) + '...'
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–µ—à –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è
      if (response.usage?.cache_read_input_tokens > 0) {
        this.log('üéâ –ö–ï–®–ò–†–û–í–ê–ù–ò–ï –†–ê–ë–û–¢–ê–ï–¢!', {
          savedTokens: response.usage.cache_read_input_tokens,
          estimatedSavings: `$${(response.usage.cache_read_input_tokens * 0.003 * 0.9 / 1000).toFixed(4)}`
        });
      } else {
        this.log('‚ö†Ô∏è –ö–µ—à –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è', { reason: '–í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–º–ø—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π' });
      }
      
      return response;
      
    } catch (error) {
      this.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–µ—à–∞', { error: error.message });
      throw error;
    }
  }

  async testCacheExpiry(systemPrompt) {
    this.log('\n=== –¢–ï–°–¢ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–µ—à–∞ (6 –º–∏–Ω—É—Ç) ===');
    this.log('‚è∞ –ñ–¥–µ–º 6 –º–∏–Ω—É—Ç –¥–ª—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–µ—à–∞...');
    
    // –ñ–¥–µ–º 6 –º–∏–Ω—É—Ç (360 —Å–µ–∫—É–Ω–¥)
    for (let i = 360; i > 0; i -= 30) {
      process.stdout.write(`\r‚è±Ô∏è  –û—Å—Ç–∞–ª–æ—Å—å: ${Math.floor(i/60)}:${(i%60).toString().padStart(2, '0')}`);
      await new Promise(resolve => setTimeout(resolve, 30000));
    }
    console.log('\n');
    
    const startTime = Date.now();
    
    try {
      const response = await anthropic.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 500,
        system: [{
          type: 'text',
          text: systemPrompt,
          cache_control: { type: 'ephemeral' }
        }],
        messages: [{
          role: 'user',
          content: '–ö–∞–∫ –¥–µ–ª–∞ —Å–µ–π—á–∞—Å? (—Ç–µ—Å—Ç –ø–æ—Å–ª–µ 6 –º–∏–Ω—É—Ç)'
        }]
      });
      
      const responseTime = Date.now() - startTime;
      
      this.log('‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ 6 –º–∏–Ω—É—Ç —É—Å–ø–µ—à–µ–Ω', {
        responseTime: `${responseTime}ms`,
        usage: response.usage,
        cacheRecreated: response.usage?.cache_creation_input_tokens > 0,
        cacheExpired: response.usage?.cache_read_input_tokens === 0
      });
      
      if (response.usage?.cache_creation_input_tokens > 0) {
        this.log('‚úÖ –ö–µ—à –∏—Å—Ç–µ–∫ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–ª—Å—è (–∫–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å)');
      }
      
    } catch (error) {
      this.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è', { error: error.message });
    }
  }

  async testMultipleMessages(systemPrompt) {
    this.log('\n=== –¢–ï–°–¢ 4: –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ–¥–Ω–∏–º –ø—Ä–æ–º–ø—Ç–æ–º ===');
    
    const messages = [
      '–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç?',
      '–ö–∞–∫ –¥–æ–ª–≥–æ —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è?', 
      '–ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è?'
    ];
    
    for (let i = 0; i < messages.length; i++) {
      const startTime = Date.now();
      
      try {
        const response = await anthropic.messages.create({
          model: 'claude-3-5-sonnet-20241022',
          max_tokens: 300,
          system: [{
            type: 'text',
            text: systemPrompt,
            cache_control: { type: 'ephemeral' }
          }],
          messages: [{
            role: 'user',
            content: messages[i]
          }]
        });
        
        const responseTime = Date.now() - startTime;
        
        this.log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ ${i+1} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ`, {
          message: messages[i],
          responseTime: `${responseTime}ms`,
          cacheHit: response.usage?.cache_read_input_tokens > 0,
          tokensFromCache: response.usage?.cache_read_input_tokens || 0
        });
        
        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
        await new Promise(resolve => setTimeout(resolve, 2000));
        
      } catch (error) {
        this.log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ ${i+1}`, { error: error.message });
      }
    }
  }

  printSummary() {
    console.log('\nüìä –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢:\n');
    
    const cacheHits = this.testResults.filter(r => r.data.cacheRead > 0).length;
    const totalTests = this.testResults.filter(r => r.data.usage).length;
    
    console.log(`‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: ${totalTests}`);
    console.log(`üéØ –ü–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à: ${cacheHits}`);
    console.log(`üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∞: ${totalTests > 0 ? Math.round(cacheHits/totalTests*100) : 0}%`);
    
    const totalSavedTokens = this.testResults
      .filter(r => r.data.tokensFromCache)
      .reduce((sum, r) => sum + r.data.tokensFromCache, 0);
    
    if (totalSavedTokens > 0) {
      console.log(`üí∞ –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: ${totalSavedTokens}`);
      console.log(`üíµ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è: $${(totalSavedTokens * 0.003 * 0.9 / 1000).toFixed(4)}`);
    }
    
    console.log('\nüìù –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ testResults –º–∞—Å—Å–∏–≤–µ');
  }
}

// –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
async function runTests() {
  const tester = new AnthropicCacheTest();
  
  try {
    await tester.testPromptCaching();
  } catch (error) {
    console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
    process.exit(1);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é
if (import.meta.url === `file://${process.argv[1]}`) {
  runTests();
}

export default AnthropicCacheTest;